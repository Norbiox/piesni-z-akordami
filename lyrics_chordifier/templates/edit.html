{% extends 'base.html' %}

{% block title %}{{ hymn.title }}{% endblock %}

{% block content %}
  <link rel="stylesheet" href="{{ url_for('static', filename='keyboard.js') }}">
  <div id="chords_menu" class="sticky-top justify-content-center" style="width: 100%;">
    <div class="d-flex flex-row justify-content-center">
      {% for chord_base in ("c", "cis", "d", "dis", "e", "f", "fis", "g", "gis", "a", "b", "h") %}
        <div class="btn-group-vertical btn-group-sm" role="toolbar">
          <button type="button" class="chordButton btn btn-primary" onclick="setChord('{{ chord_base.title() }}')">{{ chord_base.title() }}</button>
          <button type="button" class="chordButton btn btn-primary" onclick="setChord('{{ chord_base }}')">{{ chord_base }}</button>
          <button type="button" class="chordButton btn btn-primary" onclick="setChord('{{ chord_base.title() }}7')">{{ chord_base.title() }}7</button>
          <button type="button" class="chordButton btn btn-primary" onclick="setChord('{{ chord_base }}7')">{{ chord_base }}7</button>
        </div>
      {% endfor %}
    </div>
    <div class="d-flex flex-row justify-content-center">
      <button type="button" class="resetChordButton btn btn-primary" onclick="setChord('&nbsp;')">Reset</button>
    </div>
  </div>


  <section id="edycja" style="user-select: none;">
    <h3>{{ hymn.title }}</h3>
    {% for line in hymn.lyrics %}
      {% set line_i = loop.index %}
      <div class="line d-flex flex-row flex-wrap mb-3" style="font-family: monospace;">
      {% for character in line %}
        {% set character_i = loop.index %}
        <div class="character" id="line_{{ line_i }}_char_{{ character_i }}" onclick="mark({{ line_i }}, {{ character_i }})">
          <div style="font-weight: 700;">
            {% set chord = hymn.chords[line_i - 1][character_i - 1] %}
            {% if chord %}
              {{ chord }}
            {% else %}
              &nbsp;
            {% endif %}
          </div>
          <div>
            {% if character == ' ' %}
            &nbsp;
            {% else %}
            {{ character }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
      </div>
    {% endfor %} 
  </section>

  <script>
    const linesNumber = document.getElementsByClassName('line').length
    console.log(`Number of lines: ${linesNumber}`)

    const charactersNumber = []
    for (i=0; i<linesNumber; i++) {
      charactersNumber.push(document.getElementsByClassName('line')[i].getElementsByClassName('character').length)
      console.log(`Number of characters in line ${i}: ${charactersNumber[i]}`)
    }

    const coordsToId = (line, character) => `line_${line}_char_${character}`
    const idToCoords = (id) => [id.split("_")[1] - 1, id.split("_")[3] - 1]

    let currentMark = [0, 0];

    // Mark clicked character as currently edited - sets 'currentMark' variable for chord setting
    let mark = function(line, character) {
      // remove border from all characters
      Array.from(document.getElementsByClassName("character")).forEach((el) => {el.classList.remove("border", "border-danger")})
      // set currently marked character
      currentMark = [line, character]
      // add border to currently marked character
      document.getElementById(coordsToId(line, character)).classList.add("border", "border-danger")
    }

    // Set chord for currently marked character (or any given) and send to backend
    let setChord = function(chord, mark=currentMark) {
      let charId = coordsToId(...mark)
      console.log(`Setting chord ${chord} on character ${charId}`)
      document.getElementById(charId).children[0].innerHTML = chord
      let [line, character] = mark
      chord = chord.trim()
      fetch(
        "{{ url_for('views.add_chord', uid=hymn.uid) }}", 
        {
          method: "POST",
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({line: line, character: character, chord: chord})
        }
      ).then((response) => {console.log(response)})
    }
  </script>
{% endblock %}
